<!-- ============= EXPLORACI√ìN DE LUGARES ============= -->
<div class="places-page">

  <!-- HERO SUPERIOR -->
  <section class="places-hero">
    <div class="hero-left">
      <p class="hero-badge">Exploraci√≥n de lugares</p>
      <h1>Panel de Lugares</h1>
      <p class="hero-sub">
        Visualiza todos los puntos naturales registrados y lanza un an√°lisis
        inteligente con IA en un solo clic.
      </p>
      <div class="hero-stats">
        <div class="stat-pill">
          <span class="label">Lugares registrados</span>
          <span class="value">{{ places.length }}</span>
        </div>
        <div class="stat-pill">
          <span class="label">Modo</span>
          <span class="value">Administrador</span>
        </div>
      </div>
    </div>

    <div class="hero-right">
      <button
        nz-button
        nzType="primary"
        class="btn-ia-primary"
        (click)="analyzePlacesWithIA()">
        <span nz-icon nzType="line-chart"></span>
        Analizar lugares con IA
      </button>

      <div class="hero-mini-cards">
        <div class="mini-card">
          <span class="mini-label">Visi√≥n IA</span>
          <span class="mini-value">Resumen global</span>
        </div>
        <div class="mini-card">
          <span class="mini-label">Mapa</span>
          <span class="mini-value">Revisa en detalle cada lugar</span>
        </div>
      </div>
    </div>
  </section>

  <!-- TARJETA DE TABLA -->
  <section class="places-card">
    <header class="card-header">
      <div>
        <h2>Listado de lugares</h2>
        <p>Consulta r√°pidamente todos los lugares registrados en NatureApp.</p>
      </div>
      <span class="pill-soft">
        <span class="dot"></span>
        Datos sincronizados
      </span>
    </header>

    <div class="table-wrap">
      <table class="table places-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Latitud</th>
            <th>Longitud</th>
            <th class="th-actions">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let place of places; index as i">
            <td>{{ i + 1 }}</td>
            <td>
              <div class="place-name-cell">
                <span class="place-name">{{ place.name }}</span>
                <span class="place-sub">ID: {{ place.id }}</span>
              </div>
            </td>
            <td>
              <span class="chip-category">
                {{ place.category }}
              </span>
            </td>
            <td>{{ place.latitude | number:'1.4-6' }}</td>
            <td>{{ place.longitude | number:'1.4-6' }}</td>
            <td class="td-actions">
              <a class="btn-detail" [routerLink]="['/admin','places', place.id]">
                Ver detalle
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- ============= MODAL IA ============= -->
<nz-modal
  class="ia-dashboard-modal"
  [(nzVisible)]="iaModalVisible"
  [nzWidth]="1180"
  nzCentered="true"
  [nzFooter]="null"
  nzTitle="An√°lisis Inteligente de Lugares"
  (nzOnCancel)="closeIaModal()">

  <ng-container *nzModalContent>
    <div class="ia-wrapper">
      <nz-spin [nzSpinning]="iaLoading" nzTip="Procesando an√°lisis...">

        <!-- ========== CONTENIDO CON DATOS ========== -->
        <ng-container *ngIf="placeAnalysis as pa; else iaEmpty">

          <!-- ===== BARRA SUPERIOR ===== -->
          <section class="ia-header-belt">
            <div class="ia-header-main">
              <p class="ia-breadcrumb">Dashboard IA ¬∑ Lugares naturales</p>
              <h2>Visi√≥n general de NatureApp</h2>
              <p class="ia-subtitle">
                An√°lisis autom√°tico de rating, senderos, fotos y accesibilidad.
              </p>
              <p class="ia-micro">
                Basado en {{ pa.summary.totalPlaces }} lugares
                y {{ pa.summary.totalReviews }} rese√±as.
              </p>
            </div>

            <div class="ia-header-side">
              <div class="header-pill">
                <span class="pulse-dot"></span>
                Insights en tiempo real
              </div>
              <div class="header-metrics">
                <div class="header-metric">
                  <span class="label">Rating global</span>
                  <span class="value">
                    {{ pa.summary.averageRatingGlobal | number:'1.1-2' }}‚òÖ
                  </span>
                  <span class="mini">Percepci√≥n promedio</span>
                </div>
                <div class="header-metric">
                  <span class="label">Senderos</span>
                  <span class="value">
                    {{ pa.summary.averageTrailsPerPlace | number:'1.1-2' }}
                  </span>
                  <span class="mini">Por lugar</span>
                </div>
                <div class="header-metric">
                  <span class="label">Fotos</span>
                  <span class="value">
                    {{ pa.summary.averagePhotosPerPlace | number:'1.1-2' }}
                  </span>
                  <span class="mini">Por lugar</span>
                </div>
              </div>
            </div>
          </section>

          <!-- ===== CINTA DE KPIs ===== -->
          <section class="kpi-grid">
            <article class="kpi-card kpi-main">
              <div class="kpi-main-title">Inventario total</div>
              <div class="kpi-main-value">{{ pa.summary.totalPlaces }}</div>
              <div class="kpi-main-desc">Lugares activos en NatureApp</div>
            </article>

            <article class="kpi-card">
              <div class="kpi-label">Rating global</div>
              <div class="kpi-value">
                {{ pa.summary.averageRatingGlobal | number:'1.1-2' }}‚òÖ
              </div>
              <div class="kpi-sub">Satisfacci√≥n general</div>
            </article>

            <article class="kpi-card">
              <div class="kpi-label">Senderos promedio</div>
              <div class="kpi-value">
                {{ pa.summary.averageTrailsPerPlace | number:'1.1-2' }}
              </div>
              <div class="kpi-sub">Conectividad por lugar</div>
            </article>

            <article class="kpi-card">
              <div class="kpi-label">Fotos promedio</div>
              <div class="kpi-value">
                {{ pa.summary.averagePhotosPerPlace | number:'1.1-2' }}
              </div>
              <div class="kpi-sub">Nivel visual del contenido</div>
            </article>
          </section>

          <!-- ===== GRID PRINCIPAL (3 COLUMNAS) ===== -->
          <section class="ia-main-grid">

            <!-- DONUT ACCESIBILIDAD -->
            <article class="ia-panel donut-panel">
              <header class="panel-header">
                <span class="panel-icon">üìä</span>
                <div>
                  <h3>Accesibilidad general</h3>
                  <p>Proporci√≥n de lugares accesibles vs no accesibles.</p>
                </div>
              </header>

              <div class="donut-wrap">
                <div
                  class="donut"
                  [style.--percent]="(pa.accessibilityStats.accessiblePlaces / pa.summary.totalPlaces) * 100">
                  <div class="donut-inner">
                    <span class="donut-value">
                      {{
                        (pa.accessibilityStats.accessiblePlaces / pa.summary.totalPlaces) * 100
                          | number:'1.0-0'
                      }}%
                    </span>
                    <span class="donut-label">Accesibles</span>
                  </div>
                </div>

                <div class="donut-legend">
                  <div class="legend-row">
                    <span class="legend-dot legend-accessible"></span>
                    <span class="legend-label">Accesibles</span>
                    <span class="legend-value">
                      {{ pa.accessibilityStats.accessiblePlaces }}
                    </span>
                  </div>
                  <div class="legend-row">
                    <span class="legend-dot legend-non"></span>
                    <span class="legend-label">No accesibles</span>
                    <span class="legend-value">
                      {{ pa.accessibilityStats.nonAccessiblePlaces }}
                    </span>
                  </div>
                  <p class="legend-note">
                    Nivel de accesibilidad ideal para familias y p√∫blico general.
                  </p>
                </div>
              </div>
            </article>

            <!-- BARRAS POR CATEGOR√çA -->
            <article class="ia-panel">
              <header class="panel-header">
                <span class="panel-icon">üìà</span>
                <div>
                  <h3>Rating medio por categor√≠a</h3>
                  <p>Comparativo visual de las categor√≠as principales.</p>
                </div>
              </header>

              <div class="bars-list">
                <div class="bar-item" *ngFor="let c of pa.categoryStats">
                  <div class="bar-head">
                    <span class="bar-label">{{ c.category }}</span>
                    <span class="bar-rating">
                      {{ c.averageRating | number:'1.1-2' }}‚òÖ
                    </span>
                  </div>
                  <div class="bar-track">
                    <div
                      class="bar-fill"
                      [style.width.%]="(c.averageRating / 5) * 100">
                    </div>
                  </div>
                  <div class="bar-meta">
                    {{ c.placeCount }} lugares ¬∑
                    {{ c.averageReviewsPerPlace | number:'1.0-0' }} rese√±as/prom.
                  </div>
                </div>
              </div>
            </article>

            <!-- RANKINGS -->
            <article class="ia-panel rankings-panel">
              <header class="panel-header">
                <span class="panel-icon">üèÖ</span>
                <div>
                  <h3>Rankings destacados</h3>
                  <p>Lugares que m√°s destacan seg√∫n la IA.</p>
                </div>
              </header>

              <div class="ranking-columns">
                <div class="ranking-col">
                  <h4>Top calificados</h4>
                  <div class="rank-card" *ngFor="let r of pa.rankings.topRatedOverall">
                    <div class="rank-main">
                      <span class="dot-rank"></span>
                      <span class="rank-name">{{ r.name }}</span>
                    </div>
                    <div class="rank-meta">
                      {{ r.averageRating | number:'1.1-2' }}‚òÖ ¬∑
                      {{ r.reviewCount }} rese√±as
                    </div>
                  </div>
                </div>

                <div class="ranking-col">
                  <h4>Mejores para hiking</h4>
                  <div class="rank-card" *ngFor="let r of pa.rankings.bestForHiking">
                    <div class="rank-main">
                      <span class="dot-rank dot-hiking"></span>
                      <span class="rank-name">{{ r.name }}</span>
                    </div>
                    <div class="rank-meta">
                      {{ r.trailCount }} senderos ¬∑
                      {{ r.averageRating | number:'1.1-2' }}‚òÖ
                    </div>
                  </div>
                </div>
              </div>

              <div class="popular-strip">
                <h4>M√°s populares</h4>
                <div class="popular-chips">
                  <div class="pop-chip" *ngFor="let m of pa.rankings.mostPopular">
                    <div class="pop-name">{{ m.name }}</div>
                    <div class="pop-meta">
                      {{ m.reviewCount }} rese√±as ¬∑
                      {{ m.averageRating | number:'1.1-2' }}‚òÖ
                    </div>
                  </div>
                </div>
              </div>
            </article>

          </section>

          <!-- ===== GRID INFERIOR ===== -->
          <section class="ia-bottom-grid">

            <!-- LUGARES DESTACADOS -->
            <article class="ia-panel featured-panel">
              <header class="panel-header">
                <span class="panel-icon">‚≠ê</span>
                <div>
                  <h3>Lugares destacados</h3>
                  <p>Selecci√≥n r√°pida de gems, gratis y accesibles.</p>
                </div>
              </header>

              <div class="featured-grid">
                <div class="featured-col">
                  <h4>Hidden gems</h4>
                  <div class="feat-card" *ngFor="let g of pa.featured.hiddenGems">
                    <span class="feat-name">{{ g.name }}</span>
                    <span class="feat-meta">
                      {{ g.averageRating | number:'1.1-2' }}‚òÖ ¬∑
                      {{ g.reviewCount }} rese√±as
                    </span>
                  </div>
                </div>

                <div class="featured-col">
                  <h4>Gratis</h4>
                  <div class="feat-card" *ngFor="let f of pa.featured.topFreePlaces">
                    <span class="feat-name">{{ f.name }}</span>
                    <span class="feat-meta">
                      {{ f.averageRating | number:'1.1-2' }}‚òÖ
                    </span>
                  </div>
                </div>

                <div class="featured-col">
                  <h4>Accesibles</h4>
                  <div class="feat-card" *ngFor="let a of pa.featured.accessibleHighlights">
                    <span class="feat-name">{{ a.name }}</span>
                    <span class="feat-meta">
                      {{ a.averageRating | number:'1.1-2' }}‚òÖ
                    </span>
                  </div>
                </div>
              </div>
            </article>

            <!-- INSIGHTS -->
            <article class="ia-panel insights-panel">
              <header class="panel-header">
                <span class="panel-icon">‚ö°</span>
                <div>
                  <h3>Insights de IA</h3>
                  <p>Hallazgos listos para tomar decisiones.</p>
                </div>
              </header>

              <ul class="insights-list">
                <li *ngFor="let p of pa.patterns">
                  <span class="insight-bullet"></span>
                  <span>{{ p }}</span>
                </li>
              </ul>
            </article>

          </section>
        </ng-container>

        <!-- ========== SIN DATOS / ERROR ========== -->
        <ng-template #iaEmpty>
          <div class="empty-ia">
            <h3>No se pudo obtener el an√°lisis</h3>
            <p>Intenta lanzar nuevamente el an√°lisis o verifica la configuraci√≥n de IA.</p>
          </div>
        </ng-template>

      </nz-spin>
    </div>
  </ng-container>
</nz-modal>
